"use strict";(()=>{var C="http://localhost:3000";async function h(t,a={}){try{let n=await fetch(`${C}${t}`,{...a,credentials:"include",headers:{"Content-Type":"application/json",...a.headers}}),l=await n.json();return n.ok?{data:l}:{error:l.error||`HTTP ${n.status}`}}catch(n){return console.error("[API] Request failed:",n),{error:n instanceof Error?n.message:"Network error"}}}async function p(t){return h(`/api/cases/${t}`)}async function g(){return h("/api/auth/me")}var e={hostName:document.getElementById("hostName"),carrierBadge:document.getElementById("carrierBadge"),authSection:document.getElementById("authSection"),authStatus:document.getElementById("authStatus"),authText:document.getElementById("authText"),caseSection:document.getElementById("caseSection"),caseIdInput:document.getElementById("caseIdInput"),fetchCaseBtn:document.getElementById("fetchCaseBtn"),caseDetails:document.getElementById("caseDetails"),clientName:document.getElementById("clientName"),caseStatus:document.getElementById("caseStatus"),coverageInfo:document.getElementById("coverageInfo"),statusSection:document.getElementById("statusSection"),statusMessage:document.getElementById("statusMessage"),actionsSection:document.getElementById("actionsSection"),startBtn:document.getElementById("startBtn"),pauseBtn:document.getElementById("pauseBtn"),resumeBtn:document.getElementById("resumeBtn"),notCarrierSection:document.getElementById("notCarrierSection")},d=null,c=null,o=null,E=!1,y={"ipipeline.com":"iPipeline","americo.com":"Americo"};function B(t){for(let[a,n]of Object.entries(y))if(t.includes(a))return n;return null}function s(t,a){a?t.classList.remove("hidden"):t.classList.add("hidden")}function i(t,a){e.statusMessage.textContent=t,e.statusMessage.className=`status-message ${a}`,s(e.statusSection,!0)}function L(t){let{client:a}=t;if(e.clientName.textContent=`${a.firstName} ${a.lastName}`,e.coverageInfo.textContent=`$${t.coverageAmount.toLocaleString()} \xB7 ${t.termLengthYears} year term`,c){let n=t.carriers.find(l=>l.carrierPlatform===c);n&&(e.caseStatus.textContent=n.status.replace("_"," "),e.caseStatus.className=`status-badge ${n.status}`)}s(e.caseDetails,!0)}function u(t){s(e.startBtn,t==="idle"),s(e.pauseBtn,t==="running"),s(e.resumeBtn,t==="paused"||t==="error")}async function m(){let t=e.caseIdInput.value.trim();if(!t){i("Please enter a Case ID","warning");return}e.fetchCaseBtn.disabled=!0,e.fetchCaseBtn.textContent="Loading...";let a=await p(t);if(e.fetchCaseBtn.disabled=!1,e.fetchCaseBtn.textContent="Load",a.error){i(`Error: ${a.error}`,"error"),s(e.caseDetails,!1),s(e.actionsSection,!1);return}a.data&&(d=a.data,L(d),s(e.statusSection,!1),c&&(s(e.actionsSection,!0),u("idle")))}async function I(){if(!(!d||!o||!c)){e.startBtn.disabled=!0;try{await chrome.tabs.sendMessage(o,{type:"START_AUTOFILL",payload:{caseData:d}}),u("running"),i("Autofill running...","info")}catch(t){console.error("[Popup] Error starting autofill:",t),i("Failed to start autofill. Make sure you're on a supported page.","error")}e.startBtn.disabled=!1}}async function T(){o&&(await chrome.tabs.sendMessage(o,{type:"PAUSE_AUTOFILL"}),u("paused"),i("Autofill paused","warning"))}async function S(){o&&(await chrome.tabs.sendMessage(o,{type:"RESUME_AUTOFILL"}),u("running"),i("Autofill resumed...","info"))}async function M(){var n,l,f;let[t]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!(t!=null&&t.url)){e.hostName.textContent="No page detected";return}o=t.id||null;try{let r=new URL(t.url);e.hostName.textContent=r.hostname,c=B(r.hostname),c?(e.carrierBadge.textContent=c,e.carrierBadge.classList.remove("hidden"),s(e.notCarrierSection,!1)):s(e.notCarrierSection,!0)}catch{e.hostName.textContent="Invalid URL"}let a=await g();if(E=!!((n=a.data)!=null&&n.user),E?(e.authStatus.className="auth-status authenticated",e.authText.textContent=`Signed in as ${(f=(l=a.data)==null?void 0:l.user)==null?void 0:f.email}`,s(e.caseSection,!0)):(e.authStatus.className="auth-status not-authenticated",e.authText.textContent="Not signed in - open dashboard to login",s(e.caseSection,!1)),c&&o)try{let r=await chrome.tabs.sendMessage(o,{type:"GET_STATE"});r!=null&&r.state&&r.state!=="idle"&&(u(r.state),r.caseId&&(e.caseIdInput.value=r.caseId,await m()))}catch{console.log("[Popup] Content script not ready")}}e.fetchCaseBtn.addEventListener("click",m);e.caseIdInput.addEventListener("keypress",t=>{t.key==="Enter"&&m()});e.startBtn.addEventListener("click",I);e.pauseBtn.addEventListener("click",T);e.resumeBtn.addEventListener("click",S);chrome.runtime.onMessage.addListener(t=>{var a,n;switch(t.type){case"MFA_DETECTED":i("MFA required. Enter the code and click Resume.","warning"),u("paused");break;case"PAGE_COMPLETED":i(`Page completed: ${(a=t.payload)==null?void 0:a.pageId}`,"info");break;case"AUTOFILL_ERROR":i(`Error: ${(n=t.payload)==null?void 0:n.message}`,"error"),u("error");break;case"AUTOFILL_COMPLETE":i("Autofill completed!","success"),u("idle");break}});document.addEventListener("DOMContentLoaded",M);})();
