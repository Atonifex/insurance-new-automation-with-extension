"use strict";(()=>{var h="http://localhost:3000";async function p(t,a={}){try{if(typeof chrome<"u"&&chrome.runtime)try{let d=await chrome.runtime.sendMessage({type:"API_REQUEST",payload:{url:`${h}${t}`,options:{method:a.method||"GET",headers:{"Content-Type":"application/json",...a.headers},body:a.body}}});return d.error?{error:d.error}:{data:d.data}}catch{console.warn("[API] Background script unavailable, using direct fetch")}let n=await fetch(`${h}${t}`,{...a,credentials:"include",headers:{"Content-Type":"application/json",...a.headers}}),l=await n.json();return n.ok?{data:l}:{error:l.error||`HTTP ${n.status}`}}catch(n){return console.error("[API] Request failed:",n),{error:n instanceof Error?n.message:"Network error"}}}async function g(t){return p(`/api/cases/${t}`)}async function E(){return p("/api/auth/me")}var e={hostName:document.getElementById("hostName"),carrierBadge:document.getElementById("carrierBadge"),authSection:document.getElementById("authSection"),authStatus:document.getElementById("authStatus"),authText:document.getElementById("authText"),caseSection:document.getElementById("caseSection"),caseIdInput:document.getElementById("caseIdInput"),fetchCaseBtn:document.getElementById("fetchCaseBtn"),caseDetails:document.getElementById("caseDetails"),clientName:document.getElementById("clientName"),caseStatus:document.getElementById("caseStatus"),coverageInfo:document.getElementById("coverageInfo"),statusSection:document.getElementById("statusSection"),statusMessage:document.getElementById("statusMessage"),actionsSection:document.getElementById("actionsSection"),startBtn:document.getElementById("startBtn"),pauseBtn:document.getElementById("pauseBtn"),resumeBtn:document.getElementById("resumeBtn"),notCarrierSection:document.getElementById("notCarrierSection")},m=null,c=null,i=null,C=!1,y={"ipipeline.com":"iPipeline","americo.com":"Americo","transamerica.com":"Transamerica"};function T(t){if(t.protocol==="file:")return"Test";for(let[a,n]of Object.entries(y))if(t.hostname.includes(a))return n;return null}function r(t,a){a?t.classList.remove("hidden"):t.classList.add("hidden")}function o(t,a){e.statusMessage.textContent=t,e.statusMessage.className=`status-message ${a}`,r(e.statusSection,!0)}function L(t){let{client:a}=t;if(e.clientName.textContent=`${a.firstName} ${a.lastName}`,e.coverageInfo.textContent=`$${t.coverageAmount.toLocaleString()} \xB7 ${t.termLengthYears} year term`,c){let n=t.carriers.find(l=>l.carrierPlatform===c);n&&(e.caseStatus.textContent=n.status.replace("_"," "),e.caseStatus.className=`status-badge ${n.status}`)}r(e.caseDetails,!0)}function u(t){r(e.startBtn,t==="idle"),r(e.pauseBtn,t==="running"),r(e.resumeBtn,t==="paused"||t==="error")}async function f(){let t=e.caseIdInput.value.trim();if(!t){o("Please enter a Case ID","warning");return}e.fetchCaseBtn.disabled=!0,e.fetchCaseBtn.textContent="Loading...";let a=await g(t);if(e.fetchCaseBtn.disabled=!1,e.fetchCaseBtn.textContent="Load",a.error){o(`Error: ${a.error}`,"error"),r(e.caseDetails,!1),r(e.actionsSection,!1);return}a.data&&(m=a.data,L(m),r(e.statusSection,!1),c&&(r(e.actionsSection,!0),u("idle")))}async function B(){if(!(!m||!i||!c)){e.startBtn.disabled=!0;try{await chrome.tabs.sendMessage(i,{type:"START_AUTOFILL",payload:{caseData:m}}),u("running"),o("Autofill running...","info")}catch(t){console.error("[Popup] Error starting autofill:",t),o("Failed to start autofill. Make sure you're on a supported page.","error")}e.startBtn.disabled=!1}}async function I(){i&&(await chrome.tabs.sendMessage(i,{type:"PAUSE_AUTOFILL"}),u("paused"),o("Autofill paused","warning"))}async function S(){i&&(await chrome.tabs.sendMessage(i,{type:"RESUME_AUTOFILL"}),u("running"),o("Autofill resumed...","info"))}async function M(){var n,l,d;let[t]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!(t!=null&&t.url)){e.hostName.textContent="No page detected";return}i=t.id||null;try{let s=new URL(t.url);e.hostName.textContent=s.protocol==="file:"?"Local Test File":s.hostname,c=T(s),c?(e.carrierBadge.textContent=c,e.carrierBadge.classList.remove("hidden"),r(e.notCarrierSection,!1)):r(e.notCarrierSection,!0)}catch{e.hostName.textContent="Invalid URL"}let a=await E();if(C=!!((n=a.data)!=null&&n.user),C?(e.authStatus.className="auth-status authenticated",e.authText.textContent=`Signed in as ${(d=(l=a.data)==null?void 0:l.user)==null?void 0:d.email}`,r(e.caseSection,!0)):(e.authStatus.className="auth-status not-authenticated",e.authText.textContent="Not signed in - open dashboard to login",r(e.caseSection,!1)),c&&i)try{let s=await chrome.tabs.sendMessage(i,{type:"GET_STATE"});s!=null&&s.state&&s.state!=="idle"&&(u(s.state),s.caseId&&(e.caseIdInput.value=s.caseId,await f()))}catch{console.log("[Popup] Content script not ready")}}e.fetchCaseBtn.addEventListener("click",f);e.caseIdInput.addEventListener("keypress",t=>{t.key==="Enter"&&f()});e.startBtn.addEventListener("click",B);e.pauseBtn.addEventListener("click",I);e.resumeBtn.addEventListener("click",S);chrome.runtime.onMessage.addListener(t=>{var a,n;switch(t.type){case"MFA_DETECTED":o("MFA required. Enter the code and click Resume.","warning"),u("paused");break;case"PAGE_COMPLETED":o(`Page completed: ${(a=t.payload)==null?void 0:a.pageId}`,"info");break;case"AUTOFILL_ERROR":o(`Error: ${(n=t.payload)==null?void 0:n.message}`,"error"),u("error");break;case"AUTOFILL_COMPLETE":o("Autofill completed!","success"),u("idle");break}});document.addEventListener("DOMContentLoaded",M);})();
