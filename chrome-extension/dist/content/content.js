"use strict";(()=>{var y={Test:{platform:"Test",hostPattern:"file://",pages:[{id:"test_form_page1",urlPattern:"test-form.html",fields:[{caseField:"client.firstName",selectors:["#firstName","input[name='applicantFirstName']"]},{caseField:"client.middleInitial",selectors:["#middleInitial","input[name='applicantMiddleInitial']"]},{caseField:"client.lastName",selectors:["#lastName","input[name='applicantLastName']"]},{caseField:"client.dateOfBirth",selectors:["#dob","input[name='applicantDOB']"],transform:"date_mmddyyyy"},{caseField:"client.ssnLast4",selectors:["#ssn","input[name='ssnLast4']"]},{caseField:"client.address",selectors:["#address","input[name='streetAddress']"]},{caseField:"client.city",selectors:["#city","input[name='city']"]},{caseField:"client.state",selectors:["#state","select[name='state']"],inputType:"select"},{caseField:"client.zipCode",selectors:["#zip","input[name='zipCode']"]},{caseField:"client.phone",selectors:["#phone","input[name='applicantPhone']"],transform:"phone"},{caseField:"client.email",selectors:["#email","input[name='applicantEmail']"]},{caseField:"client.smokerStatus",selectors:["input[name='tobaccoUse']"],inputType:"radio"}],nextButtonSelector:"#nextBtn, button[type='submit']"}]},iPipeline:{platform:"iPipeline",hostPattern:"ipipeline.com",pages:[{id:"applicant_basic_info",urlPattern:"applicantInfo",fields:[{caseField:"client.firstName",selectors:["input[name='applicantFirstName']","#firstName","input[data-field='firstName']"]},{caseField:"client.middleInitial",selectors:["input[name='applicantMiddleInitial']","#middleInitial"]},{caseField:"client.lastName",selectors:["input[name='applicantLastName']","#lastName","input[data-field='lastName']"]},{caseField:"client.dateOfBirth",selectors:["input[name='applicantDOB']","#dob","input[data-field='dateOfBirth']"],transform:"date_mmddyyyy"},{caseField:"client.phone",selectors:["input[name='applicantPhone']","#phone"],transform:"phone"},{caseField:"client.email",selectors:["input[name='applicantEmail']","#email"]}],nextButtonSelector:"button[type='submit'], button.next-btn, #nextButton",mfaIndicators:[".mfa-verification","#otpInput","[data-testid='mfa-code']"]},{id:"applicant_address",urlPattern:"addressInfo",fields:[{caseField:"client.address",selectors:["input[name='streetAddress']","#address"]},{caseField:"client.city",selectors:["input[name='city']","#city"]},{caseField:"client.state",selectors:["select[name='state']","#state"],inputType:"select"},{caseField:"client.zipCode",selectors:["input[name='zipCode']","#zip"]}],nextButtonSelector:"button[type='submit'], button.next-btn"}]},Americo:{platform:"Americo",hostPattern:"americo.com",pages:[{id:"insured_info",urlPattern:"insured",fields:[{caseField:"client.firstName",selectors:["#insuredFirstName","input[name='insured.firstName']"]},{caseField:"client.lastName",selectors:["#insuredLastName","input[name='insured.lastName']"]},{caseField:"client.dateOfBirth",selectors:["#insuredDOB","input[name='insured.dob']"],transform:"date_mmddyyyy"},{caseField:"client.smokerStatus",selectors:["input[name='tobaccoUse']","#smokerYes, #smokerNo"],inputType:"radio"}],nextButtonSelector:".continue-btn, button[type='submit']",mfaIndicators:[".verification-code","#verificationCode"]},{id:"contact_info",urlPattern:"contact",fields:[{caseField:"client.address",selectors:["#streetAddress","input[name='address.street']"]},{caseField:"client.city",selectors:["#city","input[name='address.city']"]},{caseField:"client.state",selectors:["#state","select[name='address.state']"],inputType:"select"},{caseField:"client.zipCode",selectors:["#zipCode","input[name='address.zip']"]},{caseField:"client.phone",selectors:["#phoneNumber","input[name='phone']"],transform:"phone"},{caseField:"client.email",selectors:["#emailAddress","input[name='email']"]}],nextButtonSelector:".continue-btn, button[type='submit']"}]},Transamerica:{platform:"Transamerica",hostPattern:"transamerica.com",pages:[{id:"get_quote_page_1",urlPattern:"lifepolicyexplorer/get-quote",domMarkers:["input[data-drupal-selector='edit-your-coverage-amount-is-']","select[data-drupal-selector='edit-your-plan-is-']"],fields:[{caseField:"coverageAmount",selectors:["#edit-your-coverage-amount-is-","input[name='your_coverage_amount_is_']"]}],nextButtonSelector:"#edit-actions-wizard-next, button:contains('Next')"},{id:"personal_info_page_2",urlPattern:"lifepolicyexplorer",domMarkers:["select[data-drupal-selector='edit-where-do-you-live-']","input[data-drupal-selector='edit-zip-code']"],fields:[{caseField:"client.state",selectors:["#edit-where-do-you-live-","select[name='where_do_you_live_']","select[data-drupal-selector='edit-where-do-you-live-']"],inputType:"select"},{caseField:"client.zipCode",selectors:["#edit-zip-code","input[name='zip_code']","input[data-drupal-selector='edit-zip-code']"]},{caseField:"client.gender",selectors:["input[name='gender']","input[data-drupal-selector^='edit-gender']"],inputType:"radio"},{caseField:"client.dateOfBirth",selectors:["#edit-date-of-birth","input[name='date_of_birth']","input[data-drupal-selector='edit-date-of-birth']"],transform:"date_yyyymmdd"},{caseField:"client.weight",selectors:["#edit-weight","input[name='weight']","input[data-drupal-selector='edit-weight']"]},{caseField:"client.heightFeet",selectors:["#edit-height-items-0-item-feet","select[name='height[items][0][_item_][feet]']","select[data-drupal-selector='edit-height-items-0-item-feet']"],inputType:"select"},{caseField:"client.heightInches",selectors:["#edit-height-items-0-item-inches","select[name='height[items][0][_item_][inches]']","select[data-drupal-selector='edit-height-items-0-item-inches']"],inputType:"select"},{caseField:"client.drivingRecord",selectors:["#edit-driving-record","select[name='driving_record']","select[data-drupal-selector='edit-driving-record']"],inputType:"select"},{caseField:"client.healthStatus",selectors:["#edit-how-is-your-health-","select[name='how_is_your_health_']","select[data-drupal-selector='edit-how-is-your-health-']"],inputType:"select"},{caseField:"client.tobaccoUse",selectors:["#edit-tobacco-use","select[name='tobacco_use']","select[data-drupal-selector='edit-tobacco-use']"],inputType:"select"}],nextButtonSelector:"#edit-actions-wizard-next-v-ds5vn9row, button:contains('Next')"}]}};function w(e){if(window.location.protocol==="file:")return y.Test;for(let i of Object.values(y))if(i.platform!=="Test"&&e.includes(i.hostPattern))return i;return null}function b(e,i){for(let t of e.pages){let r=t.urlPattern;if(typeof r=="string"?i.includes(r):r.test(i)){if(t.domMarkers&&!t.domMarkers.some(c=>document.querySelector(c)))continue;return t}}return null}function k(e,i){return i.split(".").reduce((t,r)=>{if(t&&typeof t=="object"&&r in t)return t[r]},e)}function S(e,i){if(e==null)return"";let t=String(e);switch(i){case"uppercase":return t.toUpperCase();case"lowercase":return t.toLowerCase();case"phone":let r=t.replace(/\D/g,"");return r.length===10?`(${r.slice(0,3)}) ${r.slice(3,6)}-${r.slice(6)}`:t;case"date_mmddyyyy":if(/^\d{4}-\d{2}-\d{2}$/.test(t)){let[n,o,c]=t.split("-");return`${o}/${c}/${n}`}return t;case"date_yyyymmdd":return t;default:return t}}function M(e){for(let i of e){let t=document.querySelector(i);if(t)return t}return null}function v(e,i){try{if(e instanceof HTMLInputElement){let t=e.type.toLowerCase();if(t==="checkbox"){let r=i==="true"||i==="1"||i==="yes";return e.checked!==r&&(e.checked=r,u(e)),!0}if(t==="radio"){let r=document.querySelectorAll(`input[name="${e.name}"]`);for(let n of r)if(n.value.toLowerCase()===i.toLowerCase())return n.checked=!0,u(n),!0;return!1}return e.value=i,u(e),!0}if(e instanceof HTMLSelectElement){let r=Array.from(e.options).find(n=>n.value.toLowerCase()===i.toLowerCase()||n.text.toLowerCase()===i.toLowerCase());return r?(e.value=r.value,u(e),!0):!1}return e instanceof HTMLTextAreaElement?(e.value=i,u(e),!0):!1}catch(t){return console.error("[Autofill] Error setting value:",t),!1}}function u(e){e.dispatchEvent(new Event("input",{bubbles:!0,cancelable:!0})),e.dispatchEvent(new Event("change",{bubbles:!0,cancelable:!0})),e.dispatchEvent(new Event("blur",{bubbles:!0,cancelable:!0})),e.dispatchEvent(new KeyboardEvent("keyup",{bubbles:!0}))}function C(e,i){let t=k(i,e.caseField),r=S(t,e.transform);if(!r)return{success:!0,field:e.caseField};let n=M(e.selectors);return n?v(n,r)?(console.log(`[Autofill] Filled ${e.caseField}: ${r}`),{success:!0,field:e.caseField}):{success:!1,field:e.caseField,error:"Failed to set value on element"}:{success:!1,field:e.caseField,error:`No element found for selectors: ${e.selectors.join(", ")}`}}function F(e){if(!e||e.length===0)return!1;for(let r of e)if(document.querySelector(r))return console.log("[Autofill] MFA detected:",r),!0;let i=document.body.innerText.toLowerCase(),t=["enter the code","verification code","we sent a code","enter your code","two-factor","2fa","authenticate"];for(let r of t)if(i.includes(r))return console.log("[Autofill] MFA detected via text:",r),!0;return!1}function A(e){var t;let i=e.split(",").map(r=>r.trim());for(let r of i){if(r.includes(":contains(")){let o=r.match(/^([^:]+):contains\(['"]([^'"]+)['"]\)$/);if(o){let[,c,g]=o,E=document.querySelectorAll(c);for(let m of E)if((t=m.textContent)!=null&&t.includes(g)&&!m.hasAttribute("disabled"))return m.click(),console.log("[Autofill] Clicked button by text:",g),!0}continue}let n=document.querySelector(r);if(n&&!n.hasAttribute("disabled"))return n.click(),console.log("[Autofill] Clicked button:",r),!0}return console.log("[Autofill] No clickable button found for:",e),!1}function T(){let e=[],i=[".error",".error-message",".validation-error",'[role="alert"]',".field-error",".has-error",".invalid-feedback"];for(let t of i)document.querySelectorAll(t).forEach(n=>{var c;let o=(c=n.innerText)==null?void 0:c.trim();o&&o.length<200&&e.push(o)});return[...new Set(e)]}function h(e,i=5e3,t=100){return new Promise(r=>{let n=Date.now(),o=()=>{if(e()){r(!0);return}if(Date.now()-n>=i){r(!1);return}setTimeout(o,t)};o()})}var _="http://localhost:3000";async function L(e,i={}){try{if(typeof chrome<"u"&&chrome.runtime)try{let n=await chrome.runtime.sendMessage({type:"API_REQUEST",payload:{url:`${_}${e}`,options:{method:i.method||"GET",headers:{"Content-Type":"application/json",...i.headers},body:i.body}}});return n.error?{error:n.error}:{data:n.data}}catch{console.warn("[API] Background script unavailable, using direct fetch")}let t=await fetch(`${_}${e}`,{...i,credentials:"include",headers:{"Content-Type":"application/json",...i.headers}}),r=await t.json();return t.ok?{data:r}:{error:r.error||`HTTP ${t.status}`}}catch(t){return console.error("[API] Request failed:",t),{error:t instanceof Error?t.message:"Network error"}}}async function d(e,i,t,r,n){return L("/api/app-status",{method:"POST",body:JSON.stringify({caseId:e,carrierPlatform:i,status:t,pageIdentifier:r,message:n})})}var a="idle",s=null,p=null;console.log("[Autofill] Content script loaded on:",window.location.hostname);var l=w(window.location.hostname);l&&(p=l.platform,console.log("[Autofill] Detected carrier:",p));chrome.runtime.onMessage.addListener((e,i,t)=>{switch(console.log("[Autofill] Received message:",e.type),e.type){case"START_AUTOFILL":x(e.payload),t({success:!0});break;case"PAUSE_AUTOFILL":a="paused",t({success:!0});break;case"RESUME_AUTOFILL":a==="paused"&&s&&(a="running",P()),t({success:!0});break;case"GET_STATE":t({state:a,carrier:p,caseId:(s==null?void 0:s.id)||null});break;default:t({error:"Unknown message type"})}return!0});async function x(e){s=e.caseData,a="running",console.log("[Autofill] Starting with case:",s.id),p&&await d(s.id,p,"in_progress",void 0,"Autofill started"),P()}async function P(){if(!s||!l){console.log("[Autofill] No case data or carrier mapping");return}for(;a==="running";){let e=b(l,window.location.href);if(e&&F(e.mfaIndicators)){a="paused",await d(s.id,l.platform,"waiting_mfa",e.id,"MFA verification required"),chrome.runtime.sendMessage({type:"MFA_DETECTED",payload:{pageId:e.id}});return}if(!e){console.log("[Autofill] Unknown page, waiting for navigation..."),await f(1e3);continue}console.log("[Autofill] Processing page:",e.id);let i=[];for(let r of e.fields){let n=C(r,s);!n.success&&n.error&&i.push(`${n.field}: ${n.error}`)}await f(500);let t=T();if(t.length>0){console.log("[Autofill] Validation errors:",t),a="paused",await d(s.id,l.platform,"error",e.id,`Validation errors: ${t.join("; ")}`),chrome.runtime.sendMessage({type:"AUTOFILL_ERROR",payload:{message:t.join("; "),pageIdentifier:e.id}});return}if(await d(s.id,l.platform,"in_progress",e.id,"Page filled successfully"),chrome.runtime.sendMessage({type:"PAGE_COMPLETED",payload:{pageId:e.id}}),e.nextButtonSelector)if(await f(500),A(e.nextButtonSelector)){if(console.log("[Autofill] Clicked next, waiting for page change..."),!await N()){console.log("[Autofill] Page did not change, pausing"),a="paused",await d(s.id,l.platform,"error",e.id,"Navigation not detected after clicking Next");return}}else{console.log("[Autofill] Could not click next button, pausing"),a="paused",await d(s.id,l.platform,"error",e.id,"Could not find next button");return}else{console.log("[Autofill] No next button defined for page"),a="paused";return}}}function f(e){return new Promise(i=>setTimeout(i,e))}async function N(){let e=window.location.href;return await h(()=>window.location.href!==e||document.readyState!=="complete",1e4)?(await h(()=>document.readyState==="complete",5e3),await f(500),!0):!1}window.__testAutofill=e=>{x({caseData:e})};})();
