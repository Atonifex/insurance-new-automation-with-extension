"use strict";(()=>{var E={iPipeline:{platform:"iPipeline",hostPattern:"ipipeline.com",pages:[{id:"applicant_basic_info",urlPattern:"applicantInfo",fields:[{caseField:"client.firstName",selectors:["input[name='applicantFirstName']","#firstName","input[data-field='firstName']"]},{caseField:"client.middleInitial",selectors:["input[name='applicantMiddleInitial']","#middleInitial"]},{caseField:"client.lastName",selectors:["input[name='applicantLastName']","#lastName","input[data-field='lastName']"]},{caseField:"client.dateOfBirth",selectors:["input[name='applicantDOB']","#dob","input[data-field='dateOfBirth']"],transform:"date_mmddyyyy"},{caseField:"client.phone",selectors:["input[name='applicantPhone']","#phone"],transform:"phone"},{caseField:"client.email",selectors:["input[name='applicantEmail']","#email"]}],nextButtonSelector:"button[type='submit'], button.next-btn, #nextButton",mfaIndicators:[".mfa-verification","#otpInput","[data-testid='mfa-code']"]},{id:"applicant_address",urlPattern:"addressInfo",fields:[{caseField:"client.address",selectors:["input[name='streetAddress']","#address"]},{caseField:"client.city",selectors:["input[name='city']","#city"]},{caseField:"client.state",selectors:["select[name='state']","#state"],inputType:"select"},{caseField:"client.zipCode",selectors:["input[name='zipCode']","#zip"]}],nextButtonSelector:"button[type='submit'], button.next-btn"}]},Americo:{platform:"Americo",hostPattern:"americo.com",pages:[{id:"insured_info",urlPattern:"insured",fields:[{caseField:"client.firstName",selectors:["#insuredFirstName","input[name='insured.firstName']"]},{caseField:"client.lastName",selectors:["#insuredLastName","input[name='insured.lastName']"]},{caseField:"client.dateOfBirth",selectors:["#insuredDOB","input[name='insured.dob']"],transform:"date_mmddyyyy"},{caseField:"client.smokerStatus",selectors:["input[name='tobaccoUse']","#smokerYes, #smokerNo"],inputType:"radio"}],nextButtonSelector:".continue-btn, button[type='submit']",mfaIndicators:[".verification-code","#verificationCode"]},{id:"contact_info",urlPattern:"contact",fields:[{caseField:"client.address",selectors:["#streetAddress","input[name='address.street']"]},{caseField:"client.city",selectors:["#city","input[name='address.city']"]},{caseField:"client.state",selectors:["#state","select[name='address.state']"],inputType:"select"},{caseField:"client.zipCode",selectors:["#zipCode","input[name='address.zip']"]},{caseField:"client.phone",selectors:["#phoneNumber","input[name='phone']"],transform:"phone"},{caseField:"client.email",selectors:["#emailAddress","input[name='email']"]}],nextButtonSelector:".continue-btn, button[type='submit']"}]}};function g(e){for(let n of Object.values(E))if(e.includes(n.hostPattern))return n;return null}function h(e,n){for(let t of e.pages){let r=t.urlPattern;if(typeof r=="string"?n.includes(r):r.test(n)){if(t.domMarkers&&!t.domMarkers.some(l=>document.querySelector(l)))continue;return t}}return null}function P(e,n){return n.split(".").reduce((t,r)=>{if(t&&typeof t=="object"&&r in t)return t[r]},e)}function k(e,n){if(e==null)return"";let t=String(e);switch(n){case"uppercase":return t.toUpperCase();case"lowercase":return t.toLowerCase();case"phone":let r=t.replace(/\D/g,"");return r.length===10?`(${r.slice(0,3)}) ${r.slice(3,6)}-${r.slice(6)}`:t;case"date_mmddyyyy":if(/^\d{4}-\d{2}-\d{2}$/.test(t)){let[i,s,l]=t.split("-");return`${s}/${l}/${i}`}return t;case"date_yyyymmdd":return t;default:return t}}function T(e){for(let n of e){let t=document.querySelector(n);if(t)return t}return null}function x(e,n){try{if(e instanceof HTMLInputElement){let t=e.type.toLowerCase();if(t==="checkbox"){let r=n==="true"||n==="1"||n==="yes";return e.checked!==r&&(e.checked=r,d(e)),!0}if(t==="radio"){let r=document.querySelectorAll(`input[name="${e.name}"]`);for(let i of r)if(i.value.toLowerCase()===n.toLowerCase())return i.checked=!0,d(i),!0;return!1}return e.value=n,d(e),!0}if(e instanceof HTMLSelectElement){let r=Array.from(e.options).find(i=>i.value.toLowerCase()===n.toLowerCase()||i.text.toLowerCase()===n.toLowerCase());return r?(e.value=r.value,d(e),!0):!1}return e instanceof HTMLTextAreaElement?(e.value=n,d(e),!0):!1}catch(t){return console.error("[Autofill] Error setting value:",t),!1}}function d(e){e.dispatchEvent(new Event("input",{bubbles:!0,cancelable:!0})),e.dispatchEvent(new Event("change",{bubbles:!0,cancelable:!0})),e.dispatchEvent(new Event("blur",{bubbles:!0,cancelable:!0})),e.dispatchEvent(new KeyboardEvent("keyup",{bubbles:!0}))}function y(e,n){let t=P(n,e.caseField),r=k(t,e.transform);if(!r)return{success:!0,field:e.caseField};let i=T(e.selectors);return i?x(i,r)?(console.log(`[Autofill] Filled ${e.caseField}: ${r}`),{success:!0,field:e.caseField}):{success:!1,field:e.caseField,error:"Failed to set value on element"}:{success:!1,field:e.caseField,error:`No element found for selectors: ${e.selectors.join(", ")}`}}function w(e){if(!e||e.length===0)return!1;for(let r of e)if(document.querySelector(r))return console.log("[Autofill] MFA detected:",r),!0;let n=document.body.innerText.toLowerCase(),t=["enter the code","verification code","we sent a code","enter your code","two-factor","2fa","authenticate"];for(let r of t)if(n.includes(r))return console.log("[Autofill] MFA detected via text:",r),!0;return!1}function C(e){let n=e.split(",").map(t=>t.trim());for(let t of n){let r=document.querySelector(t);if(r&&!r.hasAttribute("disabled"))return r.click(),console.log("[Autofill] Clicked button:",t),!0}return console.log("[Autofill] No clickable button found for:",e),!1}function b(){let e=[],n=[".error",".error-message",".validation-error",'[role="alert"]',".field-error",".has-error",".invalid-feedback"];for(let t of n)document.querySelectorAll(t).forEach(i=>{var l;let s=(l=i.innerText)==null?void 0:l.trim();s&&s.length<200&&e.push(s)});return[...new Set(e)]}function m(e,n=5e3,t=100){return new Promise(r=>{let i=Date.now(),s=()=>{if(e()){r(!0);return}if(Date.now()-i>=n){r(!1);return}setTimeout(s,t)};s()})}var M="http://localhost:3000";async function S(e,n={}){try{let t=await fetch(`${M}${e}`,{...n,credentials:"include",headers:{"Content-Type":"application/json",...n.headers}}),r=await t.json();return t.ok?{data:r}:{error:r.error||`HTTP ${t.status}`}}catch(t){return console.error("[API] Request failed:",t),{error:t instanceof Error?t.message:"Network error"}}}async function u(e,n,t,r,i){return S("/api/app-status",{method:"POST",body:JSON.stringify({caseId:e,carrierPlatform:n,status:t,pageIdentifier:r,message:i})})}var a="idle",o=null,f=null;console.log("[Autofill] Content script loaded on:",window.location.hostname);var c=g(window.location.hostname);c&&(f=c.platform,console.log("[Autofill] Detected carrier:",f));chrome.runtime.onMessage.addListener((e,n,t)=>{switch(console.log("[Autofill] Received message:",e.type),e.type){case"START_AUTOFILL":A(e.payload),t({success:!0});break;case"PAUSE_AUTOFILL":a="paused",t({success:!0});break;case"RESUME_AUTOFILL":a==="paused"&&o&&(a="running",F()),t({success:!0});break;case"GET_STATE":t({state:a,carrier:f,caseId:(o==null?void 0:o.id)||null});break;default:t({error:"Unknown message type"})}return!0});async function A(e){o=e.caseData,a="running",console.log("[Autofill] Starting with case:",o.id),f&&await u(o.id,f,"in_progress",void 0,"Autofill started"),F()}async function F(){if(!o||!c){console.log("[Autofill] No case data or carrier mapping");return}for(;a==="running";){let e=h(c,window.location.href);if(e&&w(e.mfaIndicators)){a="paused",await u(o.id,c.platform,"waiting_mfa",e.id,"MFA verification required"),chrome.runtime.sendMessage({type:"MFA_DETECTED",payload:{pageId:e.id}});return}if(!e){console.log("[Autofill] Unknown page, waiting for navigation..."),await p(1e3);continue}console.log("[Autofill] Processing page:",e.id);let n=[];for(let r of e.fields){let i=y(r,o);!i.success&&i.error&&n.push(`${i.field}: ${i.error}`)}await p(500);let t=b();if(t.length>0){console.log("[Autofill] Validation errors:",t),a="paused",await u(o.id,c.platform,"error",e.id,`Validation errors: ${t.join("; ")}`),chrome.runtime.sendMessage({type:"AUTOFILL_ERROR",payload:{message:t.join("; "),pageIdentifier:e.id}});return}if(await u(o.id,c.platform,"in_progress",e.id,"Page filled successfully"),chrome.runtime.sendMessage({type:"PAGE_COMPLETED",payload:{pageId:e.id}}),e.nextButtonSelector)if(await p(300),C(e.nextButtonSelector))console.log("[Autofill] Clicked next, waiting for page change..."),await L();else{console.log("[Autofill] Could not click next button, pausing"),a="paused",await u(o.id,c.platform,"error",e.id,"Could not find next button");return}else{console.log("[Autofill] No next button defined for page"),a="paused";return}}}function p(e){return new Promise(n=>setTimeout(n,e))}async function L(){let e=window.location.href;await m(()=>window.location.href!==e||document.readyState!=="complete",1e4)&&(await m(()=>document.readyState==="complete",5e3),await p(500))}window.__testAutofill=e=>{A({caseData:e})};})();
